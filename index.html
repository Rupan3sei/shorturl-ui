<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>äº‘ç«¯çŸ­é“¾ Â· ç®¡ç†é¢æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" href="./assets/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="./assets/favicon.ico" type="image/x-icon" />
  <meta name="theme-color" content="#4f8cff" />

  <style>
    :root {
      --primary: #4f8cff;
      --primary-light: #e7f0ff;
      --danger: #ff4d4f;
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --text-main: #1f2933;
      --text-sub: #6b7280;
      --border-radius: 14px;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      --input-bg: #f9fafb;
      --border-color: #dde1ea;
      --chip-bg: #f3f4ff;
      --result-bg: #f9fafb;
      --result-border: #d1d5db;
    }

    /* æ·±è‰²ä¸»é¢˜å˜é‡è¦†ç›– */
    [data-theme="dark"] {
      --primary: #60a5fa;
      --primary-light: #1e293b;
      --danger: #fb7185;
      --bg: #020617;
      --card-bg: #020617;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --border-radius: 14px;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
      --input-bg: #020617;
      --border-color: #1f2937;
      --chip-bg: #0b1120;
      --result-bg: #020617;
      --result-border: #1f2937;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      transition: background 0.25s ease, color 0.25s ease;
    }

    .container {
      max-width: 780px;
      margin: 40px auto;
      padding: 0 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 24px 22px 26px;
      transition: background 0.25s ease, box-shadow 0.25s ease;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 12px;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-img {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      object-fit: contain;
      background: var(--primary-light);
      padding: 4px;
    }

    .title {
      font-size: 22px;
      font-weight: 650;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-light);
      color: var(--primary);
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .theme-toggle-btn {
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: transparent;
      padding: 6px 10px;
      font-size: 13px;
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease,
        transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12);
    }

    .theme-toggle-btn:hover {
      background: var(--primary-light);
      color: var(--primary);
    }

    .theme-toggle-btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin: 20px 0 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .field {
      flex: 1 1 220px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 13px;
      color: var(--text-sub);
    }

    input[type="text"],
    input[type="url"] {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      font-size: 13px;
      outline: none;
      background: var(--input-bg);
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s,
        color 0.2s;
      color: var(--text-main);
    }

    input[type="text"]:focus,
    input[type="url"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(79, 140, 255, 0.25);
      background: var(--card-bg);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease,
        background 0.2s ease, color 0.2s ease;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 8px 16px rgba(79, 140, 255, 0.35);
    }

    .btn-primary:hover {
      background: #3e76df;
    }

    [data-theme="dark"] .btn-primary:hover {
      background: #2563eb;
    }

    .btn-outline {
      background: transparent;
      color: var(--text-sub);
      border: 1px solid var(--border-color);
    }

    .btn-outline:hover {
      background: var(--primary-light);
      color: var(--primary);
    }

    .btn-danger {
      background: var(--danger);
      color: #ffffff;
      box-shadow: 0 8px 16px rgba(248, 113, 113, 0.35);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      color: var(--text-sub);
      margin-top: 6px;
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary);
    }

    .result-box {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: 10px;
      background: var(--result-bg);
      border: 1px dashed var(--result-border);
      font-size: 13px;
      max-height: 260px;
      overflow: auto;
      white-space: pre-wrap;
      line-height: 1.6;
      transition: background 0.25s ease, border-color 0.25s ease;
    }

    .result-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .result-item + .result-item {
      margin-top: 6px;
      border-top: 1px dashed var(--result-border);
      padding-top: 6px;
    }

    .result-key {
      font-weight: 600;
      color: var(--text-main);
    }

    .result-url {
      word-break: break-all;
      color: #2563eb;
    }

    [data-theme="dark"] .result-url {
      color: #60a5fa;
    }

    .footer {
      margin-top: 18px;
      font-size: 12px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .tag {
      font-size: 11px;
      padding: 1px 8px;
      border-radius: 999px;
      background: #f3f4f6;
    }

    [data-theme="dark"] .tag {
      background: #020617;
      border: 1px solid #1f2937;
    }

    @media (max-width: 600px) {
      .card {
        padding: 18px 16px 20px;
      }
      .title {
        font-size: 19px;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="logo-wrap">
          <img src="./assets/logo.png" alt="äº‘ç«¯çŸ­é“¾ Logo" class="logo-img" />
          <div>
            <div class="title">
              äº‘ç«¯çŸ­é“¾
              <span class="title-badge">ç®€æ´ Â· æ˜äº® Â· æ·±è‰²å¯åˆ‡æ¢</span>
            </div>
            <div class="subtitle">
              ç”Ÿæˆã€æŸ¥è¯¢å’Œç®¡ç†ä½ çš„çŸ­é“¾æ¥ã€‚å‰ç«¯çº¯é™æ€ï¼Œå¯ç›´æ¥éƒ¨ç½²åˆ° GitHub
              Pagesã€‚
            </div>
          </div>
        </div>
        <button id="theme-toggle" class="theme-toggle-btn" type="button">
          <span id="theme-icon">ğŸŒ</span>
          <span id="theme-text">æµ…è‰²æ¨¡å¼</span>
        </button>
      </div>

      <!-- åˆ›å»ºçŸ­é“¾æ¥ -->
      <div class="section">
        <div class="section-title">åˆ›å»ºçŸ­é“¾æ¥</div>
        <div class="form-row">
          <div class="field">
            <label for="long-url">åŸå§‹é“¾æ¥ï¼ˆé•¿é“¾æ¥ï¼‰</label>
            <input
              id="long-url"
              type="url"
              placeholder="ä¾‹å¦‚ï¼šhttps://www.example.com/very/long/url"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="custom-key">è‡ªå®šä¹‰çŸ­é“¾æ¥ï¼ˆå¯é€‰ï¼‰</label>
            <input
              id="custom-key"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šmy-linkï¼Œä¸å¡«åˆ™è‡ªåŠ¨ç”Ÿæˆ"
            />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div class="btn-row">
              <button id="btn-add" class="btn-primary" type="button">
                ç”ŸæˆçŸ­é“¾æ¥
              </button>
            </div>
          </div>
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          <span>å¦‚æœå¯ç”¨äº† unique_linkï¼Œä¼šå¤ç”¨ç›¸åŒé•¿é“¾æ¥çš„çŸ­åœ°å€ã€‚</span>
        </div>
      </div>

      <!-- ç®¡ç†çŸ­é“¾æ¥ -->
      <div class="section">
        <div class="section-title">æŸ¥è¯¢ / åˆ é™¤çŸ­é“¾æ¥</div>
        <div class="form-row">
          <div class="field">
            <label for="manage-key">çŸ­é“¾æ¥ Key</label>
            <input
              id="manage-key"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šmy-link æˆ– éšæœºç”Ÿæˆçš„ key"
            />
          </div>
        </div>
        <div class="btn-row">
          <button id="btn-qry" class="btn-outline" type="button">
            æŸ¥è¯¢çŸ­é“¾æ¥
          </button>
          <button id="btn-del" class="btn-danger" type="button">
            åˆ é™¤çŸ­é“¾æ¥
          </button>
          <button id="btn-qryall" class="btn-outline" type="button">
            æŸ¥è¯¢å…¨éƒ¨ï¼ˆå¦‚å·²å¯ç”¨ï¼‰
          </button>
        </div>
      </div>

      <!-- ç»“æœå±•ç¤º -->
      <div class="section">
        <div class="section-title">æ“ä½œç»“æœ</div>
        <div id="result-box" class="result-box">
          <div class="result-title">è¿˜æ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚</div>
          <div>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ° API è¿”å›çš„æ•°æ®å’Œç”Ÿæˆçš„çŸ­é“¾æ¥ã€‚</div>
        </div>
      </div>

      <div class="footer">
        <div>
          <span class="tag">å½“å‰è¯­è¨€ï¼šä¸­æ–‡ UI</span>
        </div>
        <div>Powered by Cloudflare Worker &amp; KV</div>
      </div>
    </div>
  </div>

  <!-- Worker ä¼šæŠŠ __PASSWORD__ æ›¿æ¢æˆçœŸæ­£çš„å¯†ç  -->
  <input type="hidden" id="worker-password" value="__PASSWORD__" />

  <script>
    // ä¸»é¢˜åˆ‡æ¢é€»è¾‘
    (function () {
      const root = document.documentElement;
      const toggleBtn = document.getElementById("theme-toggle");
      const iconSpan = document.getElementById("theme-icon");
      const textSpan = document.getElementById("theme-text");

      function applyTheme(theme) {
        root.setAttribute("data-theme", theme);
        if (theme === "dark") {
          iconSpan.textContent = "ğŸŒ™";
          textSpan.textContent = "æ·±è‰²æ¨¡å¼";
        } else {
          iconSpan.textContent = "ğŸŒ";
          textSpan.textContent = "æµ…è‰²æ¨¡å¼";
        }
      }

      // åˆå§‹å€¼ï¼šlocalStorage > ç³»ç»Ÿåå¥½ > é»˜è®¤ light
      const stored = localStorage.getItem("theme");
      if (stored === "dark" || stored === "light") {
        applyTheme(stored);
      } else if (window.matchMedia &&
                 window.matchMedia("(prefers-color-scheme: dark)").matches) {
        applyTheme("dark");
      } else {
        applyTheme("light");
      }

      toggleBtn.addEventListener("click", () => {
        const current = root.getAttribute("data-theme") || "light";
        const next = current === "light" ? "dark" : "light";
        applyTheme(next);
        localStorage.setItem("theme", next);
      });
    })();

    // åŸæœ‰ API è°ƒç”¨é€»è¾‘ï¼ˆç•¥æœ‰ç²¾ç®€ï¼‰
    const API_URL = window.location.origin;
    const password = document.getElementById("worker-password").value;
    const resultBox = document.getElementById("result-box");

    function appendResult(text, isError = false) {
      if (!text) return;
      const time = new Date().toLocaleTimeString();
      const content = `[${time}] ${text}`;
      const div = document.createElement("div");
      div.className = "result-item";
      if (isError) {
        div.style.color = "#b91c1c";
      }
      if (resultBox.dataset.empty !== "0") {
        resultBox.innerHTML = "";
        resultBox.dataset.empty = "0";
      }
      div.textContent = content;
      resultBox.appendChild(div);
      resultBox.scrollTop = resultBox.scrollHeight;
    }

    function showShortLink(key) {
      const shortUrl =
        window.location.origin.replace(/\/+$/, "") +
        "/" +
        encodeURIComponent(key);
      const wrapper = document.createElement("div");
      wrapper.className = "result-item";

      const label = document.createElement("div");
      label.innerHTML = `<span class="result-key">çŸ­é“¾æ¥ï¼š</span>`;
      const link = document.createElement("a");
      link.href = shortUrl;
      link.target = "_blank";
      link.className = "result-url";
      link.textContent = shortUrl;

      label.appendChild(link);
      wrapper.appendChild(label);

      resultBox.appendChild(wrapper);
      resultBox.scrollTop = resultBox.scrollHeight;
    }

    async function callApi(cmd, params) {
      try {
        const body = { cmd, password, ...params };
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const text = await res.text();
        let data = null;
        try {
          data = JSON.parse(text);
        } catch (e) {
          appendResult("è§£æè¿”å›æ•°æ®å¤±è´¥ï¼š" + text, true);
          return null;
        }

        if (data.error) {
          appendResult(data.error, true);
        } else {
          appendResult("æ“ä½œæˆåŠŸã€‚");
        }
        return data;
      } catch (err) {
        appendResult("è¯·æ±‚å¤±è´¥ï¼š" + err.message, true);
        return null;
      }
    }

    document.getElementById("btn-add").addEventListener("click", async () => {
      const url = document.getElementById("long-url").value.trim();
      const key = document.getElementById("custom-key").value.trim();

      if (!url) {
        appendResult("è¯·å…ˆå¡«å†™åŸå§‹é“¾æ¥ã€‚", true);
        return;
      }

      appendResult("æ­£åœ¨åˆ›å»ºçŸ­é“¾æ¥...");
      const data = await callApi("add", { url, key });
      if (data && data.status === 200 && data.key) {
        showShortLink(data.key);
      }
    });

    document.getElementById("btn-qry").addEventListener("click", async () => {
      const key = document.getElementById("manage-key").value.trim();
      if (!key) {
        appendResult("è¯·å…ˆå¡«å†™è¦æŸ¥è¯¢çš„çŸ­é“¾æ¥ Keyã€‚", true);
        return;
      }
      appendResult("æ­£åœ¨æŸ¥è¯¢çŸ­é“¾æ¥...");
      const data = await callApi("qry", { key });
      if (data && data.status === 200 && data.url) {
        const wrapper = document.createElement("div");
        wrapper.className = "result-item";
        wrapper.innerHTML =
          `<div><span class="result-key">Keyï¼š</span>${data.key}</div>` +
          `<div><span class="result-key">åŸé“¾æ¥ï¼š</span><a class="result-url" href="${data.url}" target="_blank">${data.url}</a></div>`;
        resultBox.appendChild(wrapper);
        resultBox.scrollTop = resultBox.scrollHeight;
      }
    });

    document.getElementById("btn-del").addEventListener("click", async () => {
      const key = document.getElementById("manage-key").value.trim();
      if (!key) {
        appendResult("è¯·å…ˆå¡«å†™è¦åˆ é™¤çš„çŸ­é“¾æ¥ Keyã€‚", true);
        return;
      }
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ­é“¾æ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;

      appendResult("æ­£åœ¨åˆ é™¤çŸ­é“¾æ¥...");
      const data = await callApi("del", { key });
      if (data && data.status === 200) {
        appendResult(`å·²åˆ é™¤çŸ­é“¾æ¥ï¼š${key}`);
      }
    });

    document.getElementById("btn-qryall").addEventListener("click", async () => {
      appendResult("æ­£åœ¨æŸ¥è¯¢å…¨éƒ¨ KVï¼ˆå¦‚æœå·²å¯ç”¨ load_kvï¼‰...");
      const data = await callApi("qryall", {});
      if (data && data.status === 200 && Array.isArray(data.kvlist)) {
        const list = data.kvlist;
        appendResult(`å…±è·å–åˆ° ${list.length} æ¡è®°å½•ã€‚`);
        list.forEach((item) => {
          const wrapper = document.createElement("div");
          wrapper.className = "result-item";
          wrapper.innerHTML =
            `<div><span class="result-key">Keyï¼š</span>${item.key}</div>` +
            `<div><span class="result-key">å€¼ï¼š</span><span class="result-url">${item.value}</span></div>`;
          resultBox.appendChild(wrapper);
        });
        resultBox.scrollTop = resultBox.scrollHeight;
      }
    });

    resultBox.dataset.empty = "1";
  </script>
</body>
</html>
